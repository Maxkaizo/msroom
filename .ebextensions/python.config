commands:
  01_install_deps:
    command: "source /var/app/venv/*/bin/activate && pip install -r /var/app/current/requirements.txt"
    ignoreErrors: true

option_settings:
  aws:autoscaling:launchconfiguration:
    IamInstanceProfile: aws-elasticbeanstalk-ec2-role
  aws:ec2:instances:
    InstanceTypes: t3.micro
  aws:elasticbeanstalk:environment:
    EnvironmentType: LoadBalanced
  aws:elasticbeanstalk:application:environment:
    PYTHONPATH: /var/app/current:$PYTHONPATH
  aws:elasticbeanstalk:cloudwatch:logs:
    StreamLogs: true
    DeleteOnTerminate: false
    RetentionInDays: 7

files:
  "/etc/systemd/system/mushroom-app.service":
    mode: "000644"
    owner: root
    group: root
    content: |
      [Unit]
      Description=Mushroom Classifier API
      After=network.target

      [Service]
      Type=simple
      User=ec2-user
      WorkingDirectory=/var/app/current
      ExecStart=/var/app/venv/*/bin/python predict.py
      Restart=always

      [Install]
      WantedBy=multi-user.target

container_commands:
  01_train_model:
    command: "source /var/app/venv/*/bin/activate && python train.py"
    leader_only: true
    ignoreErrors: true
